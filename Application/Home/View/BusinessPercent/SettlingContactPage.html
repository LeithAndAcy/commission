<html>
	<head>
		<include file="Public:commonInclude"/>
	</head>
	<body>
		<div class="col-xs-12">
			<button class="btn btn-info" data-toggle="modal" data-target="#searchModel">
				复杂搜索
			</button>
			<button class="btn btn-info" id="get_settling_contact">
				取可结算合同
			</button>
			<button class="btn btn-info" id="get_ratio_price">
				取数
			</button>
			<button class="btn btn-info" id="btn_caculate">
				计算
			</button>
		</div>
		<div class="col-xs-12">
			<table id="settlingContactTable" class="table table-striped table-bordered table-hover datatable" width="300%" cellspacing="0" style="margin-top: 20px;overflow-x: auto">
				<thead>
					<tr>
						<th>合同号</th>
						<th>销售订单号</th>
						<th>客户编码</th>
						<th>客户名称</th>
						<th>业务员编码</th>
						<th>业务员姓名</th>
						<th>存货编码</th>
						<th>存货类别编码</th>
						<th>存货名称</th>
						<th>规格型号</th>
						<th>颜色</th>
						<th>销售单价</th>
						<th>底价（元）</th>
						<th>上浮的底价（元）</th>
						<th>销售数量（米数）</th>
						<th>发货数量（米数）</th>
						<th>销售金额(元)</th>

						<th>基本业绩提成比例</th>
						<th>达标业绩提成比例</th>
						<th>基本利润提成比例</th>
						<!-- <th>回款未达标利润提成比例</th> -->

						<th>业务提成调整比例</th>
						<th>利润提成调整比例</th>
						<th>底价调整金额(元)</th>
						<th>最终实际底价(元)</th>

						<th>基本业绩提成(元)</th>
						<th>回款达标业绩提成(元)</th>
						<th>基本利润提成(元)</th>
						<!-- <th>回款未达标利润提成(元)</th> -->

						<th>提成利润合计</th>
						<th>调整比例修改人员</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody>
					<volist name="settling_contact_detail" id="vo">
						<tr>
							<td>{$vo.contact_id}</td>
							<td>{$vo.cSOCode}</td>
							<td>{$vo.customer_id}</td>
							<td>{$vo.customer_name}</td>
							<td>{$vo.salesman_id}</td>
							<td>{$vo.salesman_name}</td>
							<th>{$vo.inventory_id}</th>
							<td>{$vo.classification_id}</td>
							<td>{$vo.inventory_name}</td>
							<td>{$vo.specification}</td>
							<td>{$vo.colour}</td>
							<td>{$vo.sale_price}</td>
							<td>{$vo.cost_price}</td>
							<td>{$vo.float_price}</td>
							<td>{$vo.sale_quantity}</td>
							<td>{$vo.delivery_quantity}</td>
							<td>{$vo.delivery_money}</td>
							<td>{$vo.normal_business_ratio}%</td>
							<td>{$vo.special_business_ratio}%</td>
							<td>{$vo.normal_profit_ratio}%</td>
							<!-- <td>{$vo.special_profit_ratio}%</td> -->
							<td id="{$vo.contact_id}_{$vo.inventory_id}_business_adjust">{$vo.business_adjust}%</td>
							<td id="{$vo.contact_id}_{$vo.inventory_id}_profit_adjust">{$vo.profit_adjust}%</td>
							<td id="{$vo.contact_id}_{$vo.inventory_id}_cost_price_adjust">{$vo.cost_price_adjust}</td>
							<td>{$vo.end_cost_price}</td>
							<td>{$vo.normal_business}</td>
							<td>{$vo.special_business}</td>
							<td>{$vo.normal_profit}</td>
							<!-- <td>{$vo.special_profit}</td> -->
							<td>{$vo.total_business_profit}</td>
							<td>{$vo.operator}</td>
							<td contact_id="{$vo.contact_id}" inventory_id="{$vo.inventory_id}"><span style="margin-left: 10px;margin-right: 10px;cursor: pointer;"> <img title="Edit"  alt="编辑" src="__PUBLIC__/img/edit.png" data-toggle="modal" data-target="#editDetail"> </span><span style="margin-left: 10px;margin-right: 10px;cursor: pointer;"> <img title="Delete" alt="删除" src="__PUBLIC__/img/delete.png"> </span></td>
						</tr>
					</volist>
				</tbody>
			</table>
		</div>
		<div align="right">
			{$page}
		</div>
		<div class="modal fade" id="searchModel" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">
							<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
						</button>
						<h4 class="modal-title" id="myModalLabel">复杂搜索</h4>
					</div>
					<form class="form-horizontal" role="form" method="post" action="complicateSearch" >
						<div class="modal-body">
							<div class="modal-body">
								<div class="form-group">
									<label class="col-sm-4 control-label">合同号</label>
									<div class="col-sm-6">
										<input type="text" class="form-control" name="search_contact_id">
									</div>
								</div>
								<div class="form-group">
									<label  class="col-sm-4 control-label">存货编码</label>
									<div class="col-sm-6">
										<input type="text" class="form-control" name="search_inventory_id" >
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-4 control-label">存货分类编码</label>
									<div class="col-sm-6">
										<input type="text" class="form-control" name="search_classification_id">
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-4 control-label">规格型号</label>
									<div class="col-sm-6">
										<input type="text" class="form-control" name="search_specification">
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-4 control-label">颜色</label>
									<div class="col-sm-6">
										<input type="text" class="form-control" name="search_colour">
									</div>
								</div>
								<div class="hidden">
									<input type="text" name="search_type" value="settling" />
								</div>
							</div>
							<div class="modal-footer">
								<input type="button" class="btn btn-default" data-dismiss="modal" value="取消"/>
								<input type="submit" class="btn btn-primary" value="确定"/>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
		<div class="modal fade" id="editDetail" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">
							<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
						</button>
						<h4 class="modal-title" id="myModalLabel">修改</h4>
					</div>
					<form class="form-horizontal" role="form" method="post" action="ratioAdjust">
						<div class="modal-body">
							<div class="form-group">
								<label class="col-sm-4 control-label">业务提成调整比例</label>
								<div class="col-sm-6 input-group" style="padding-left: 15px;padding-right: 14px" >
									<input type="text" name="edit_business_adjust" id="edit_business_adjust" class="form-control validate[required,[custom[number]]">
									<span class="input-group-addon">%</span>
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-4 control-label">利润提成调整比例</label>
								<div class="col-sm-6 input-group" style="padding-left: 15px;padding-right: 14px" >
									<input type="text" name="edit_profit_adjust" id="edit_profit_adjust" class="form-control validate[required,[custom[number]]">
									<span class="input-group-addon">%</span>
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-4 control-label">调整底价金额</label>
								<div class="col-sm-6 input-group" style="padding-left: 15px;padding-right: 14px" >
									<input type="text" name="edit_cost_price_adjust" id="edit_cost_price_adjust" class="form-control validate[required,[custom[number]]">
									<span class="input-group-addon">元</span>
								</div>
							</div>
							<div class="hidden">
								<input type="text" name="edit_contact_id"  id="edit_contact_id" value=""/>
								<input type="text" name="edit_inventory_id" id="edit_inventory_id" value=""/>
								;
							</div>
						</div>
						<div class="modal-footer">
							<input type="button" class="btn btn-default" data-dismiss="modal" value="取消"/>
							<input type="submit" class="btn btn-primary" value="确定"/>
						</div>
					</form>
				</div>
			</div>
		</div>
	</body>
</html>
<script>
	$(function() {
		var table = $('#settlingContactTable').DataTable( {
			scrollY:        "500px",
			scrollX:        true,
			scrollCollapse: true,
			paging:         true
		});
		 new $.fn.dataTable.FixedColumns(table, {
			leftColumns: 6
			// rightColumns: 1
		});
		$("#get_settling_contact").click(function() {
			$.post("__CONTROLLER__/getSettlingContact", {}, function(data) {
				window.location.href = "/commission/index.php/Home/BusinessPercent/loadSettlingContactPage";
			});
		});
		$("#get_ratio_price").click(function() {
			$.post("__CONTROLLER__/getSettlingRatioAndPrice", {}, function(data) {
				window.location.href = "/commission/index.php/Home/BusinessPercent/loadSettlingContactPage";
			});
		});
		$("#settlingContactTable tbody").on("click", "tr td span img:even", function() {
			var contact_id = $(this).parent().parent().attr('contact_id');
			var inventory_id = $(this).parent().parent().attr('inventory_id');
			var business_adjust = $("#" + contact_id + "_" + inventory_id + "_business_adjust").text();
			var profit_adjust = $("#" + contact_id + "_" + inventory_id + "_profit_adjust").text();
			var cost_price_adjust = $("#" + contact_id + "_" + inventory_id + "_cost_price_adjust").text();

			business_adjust = business_adjust.slice(0, -1);
			profit_adjust = profit_adjust.slice(0, -1);

			$("#edit_business_adjust").val(business_adjust);
			$("#edit_profit_adjust").val(profit_adjust);
			$("#edit_cost_price_adjust").val(cost_price_adjust);

			$("#edit_contact_id").val(contact_id);
			$("#edit_inventory_id").val(inventory_id);
		});
		$("#settlingContactTable tbody").on("click","tr td span img:odd",function() {
			var temp = confirm("确认删除该条合同吗？");
			if(temp){
				var contact_id = $(this).parent().parent().attr('contact_id');
				var inventory_id = $(this).parent().parent().attr('inventory_id');
				$.post("__CONTROLLER__/deleteContact", {
					"contact_id" : contact_id,
					"inventory_id" : inventory_id,
				}, function(data) {
					window.location.href="/commission/index.php/Home/BusinessPercent/loadSettlingContactPage";
				});
			}
		});
		$("#btn_caculate").click(function() {
			$.post("__CONTROLLER__/settleContact", {}, function(data) {
				window.location.href = "/commission/index.php/Home/BusinessPercent/loadSettlingContactPage";
			});
		});
	}); 
</script>

